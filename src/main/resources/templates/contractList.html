<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<div th:fragment="contractList">
    <link th:href="@{99/css/plugins/ladda/ladda-themeless.min.css}" rel="stylesheet"/>
    <style type="text/css">
        #contracttable_length  select {
            padding-top: 3px;
        }
    </style>
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h2>合同列表</h2>
            <ol class="breadcrumb">
                <li>
                    <a href="index.html">首页</a>
                </li>
                <li>
                    <a>业务数据管理</a>
                </li>
                <li class="active">
                    <strong>合同管理</strong>
                </li>
            </ol>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight ecommerce">
        <div class="ibox-content m-b-sm border-bottom">
            <div class="row">
                <!--<div class="col-sm-2">-->
                    <!--<div class="form-group">-->
                        <!--<label for="name" class="control-label">合同名称</label>-->
                        <!--<input type="text"  id="name" class="form-control input-sm" onkeydown='if(event.keyCode==13){query();}'/>-->
                    <!--</div>-->
                <!--</div>-->
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="code" class="control-label">合同编码</label>
                        <input type="text"  id="code" class="form-control input-sm" onkeydown='if(event.keyCode==13){query();}'/>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="exhibitionNumber" class="control-label">展位号</label>
                        <input type="text"  id="exhibitionNumber" class="form-control input-sm" onkeydown='if(event.keyCode==13){query();}'/>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="category" class="control-label">合同分类</label>
                        <select name="category" id="category" class="form-control input-sm" style="padding-top: 3px;" onchange="query();">
                            <option value="" selected="selected">不限</option>
                            <option value="C">销售合同</option>
                            <option value="S">供应商合同-主办方</option>
                            <option value="D">供应商合同-设计师</option>
                            <option value="F">供应商合同-工厂</option>
                            <option value="P">供应商合同-项目经理</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="firstParty" class="control-label">合同甲方</label>
                        <input type="text" readonly="readonly"  id="firstParty" class="form-control input-sm" onclick="ABonClick(this)" style="cursor: pointer"/>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="secondParty" class="control-label">合同乙方</label>
                        <input type="text" readonly="readonly"  id="secondParty" class="form-control input-sm" onclick="ABonClick(this)" style="cursor: pointer"/>
                    </div>
                </div>
                <div class="col-sm-2">
                    <form class="form-inline">
                        <div class="form-group">
                            <button class="btn btn-primary btn-sm" type="button" style="width: 100%;margin-top: 23px;" onclick="query();">查&nbsp;&nbsp;询</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning btn-sm" type="button" style="width: 100%;margin-top: 23px;" onclick="resetForm();">重&nbsp;&nbsp;置</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content table-responsive">
                        <table id="contracttable" class="table table-striped table-bordered table-hover dataTables-example">
                            <thead>
                            <tr>
                                <th>操作</th>
                                <th>合同签署日期</th>
                                <!--<th>合同名称</th>-->
                                <th>合同编号</th>
                                <th>项目编号</th>
                                <th>项目名称</th>
                                <th>市场活动</th>
                                <th>展位号</th>
                                <th>合同总价</th>
                                <th>合同分类</th>
                                <th>创建时间</th>
                                <th>修改时间</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!--ABTableModal-->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="ABTableModal">
        <input type="hidden" id="typeValue" value="C"/>
        <div class="modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>请选择一个分类</h3>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="radio radio-inline radio-info">
                                            <input type="radio" name="state" id="s1" value="C" checked="checked" onclick="queryABTable(this)"/>
                                            <label for="s1">
                                                客户
                                            </label>
                                        </div>
                                        <div class="radio radio-inline radio-info">
                                            <input type="radio" name="state" id="s2" value="F" onclick="queryABTable(this)"/>
                                            <label for="s2">
                                                工厂
                                            </label>
                                        </div>
                                        <div class="radio radio-inline radio-info">
                                            <input type="radio" name="state" id="s3" value="U" onclick="queryABTable(this)"/>
                                            <label for="s3">
                                                人
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <table id="ABTable" class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>操作</th>
                                        <th>名称</th>
                                    </tr>
                                    </thead>
                                </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn ladda-button btn-primary" id="ABConfrim" onclick="chooseAB(this);"><span class="ladda-label">确定</span></button>
                </div>
            </div>
        </div>
    </div>

    <!--台账Modal-->
    <input type="hidden" name="id" id="id"/>
    <!-- Data picker -->
    <script th:src="@{99/js/plugins/datapicker/bootstrap-datepicker.js}"></script>
    <script th:src="@{99/js/plugins/ladda/spin.min.js}"></script>
    <script th:src="@{99/js/plugins/ladda/ladda.min.js}"></script>

    <script th:src="@{jquery.koala.js}" type="text/javascript"></script>
    <script th:src="@{me.js}" type="text/javascript"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var hasCreate = [[${#authorization.url('/contractCreate')}]]; // 合同新建

        var hasEdit = [[${#authorization.url('/edit')}]];// 合同编辑权限
        var hasContractView = [[${#authorization.url('/contractContractView')}]];// 合同查看权限

        var contractDonwLoad = [[${#authorization.url('/contractDonwLoad')}]]; // 合同下载

        var hasLedgerEdit = [[${#authorization.url('/ledgerEdit')}]];// 台账编辑权限
        var hasLedgerView = [[${#authorization.url('/ledgerView')}]];// 台账查看权限

        /***
         *
         * 检索相关
         *
         **/
        var ABTable = null;
        function ABTableInit() {

            ABTable = $('#ABTable').DataTable({
                "sScrollX": true,
                "ajax": {
                    "url": "loadABTable",
                    "dataType": 'json',
                    "type": "POST",
                    contentType: 'application/json; charset=utf-8',

                    "data": function (d) {
                        var p = {};
                        p.draw = d.draw;
                        p.length = d.length;
                        p.start = d.start;
                        p.search = d.search.value;
                        p.type = $("#typeValue").val();
                        var a = JSON.stringify(p);
                        return a;
                    }
                },

                "columns": [
                    {
                        "data": "id", "width": "250px",
                        "render": function (data, type, row) {
                            var u = "";
                            u =  "<input type=\"radio\" style=\"cursor:pointer;\" name='ABTable' value='" + row.id + "' ABName='" + row.name + "'/>";
                            return u;

                        },
                    },

                    {"data": "name", "width": "270px"},
                ]
                , language: {
                    lengthMenu: '每页显示 <select class="form-control input-sm">'
                    + '<option value="10">10</option>'
                    + '<option value="20">20</option>'
                    + '<option value="100">100</option>'
                    + '</select> 条'
                    ,
                    processing: "载入中 ...",//处理页面数据的时候的显示
                    paginate: {//分页的样式文本内容。
                        previous: "上一页",
                        next: "下一页",
                        first: "第一页",
                        last: "最后一页"
                    },
                    "sSearch": "搜索",
                    zeroRecords: "没有数据",//table tbody内容为空时，tbody的内容。
                    //下面三者构成了总体的左下角的内容。
                    info: "当前显示第_START_到第_END_条 ，共_PAGES_ 页 ",//左下角的信息显示，大写的词为关键字。
                    infoEmpty: "0个",//筛选为空时左下角的显示。
                    infoFiltered: ""//筛选之后的左下角筛选提示(另一个是分页信息显示，在上面的info中已经设置，所以可以不显示)，
                }
                , "lengthChange": true
                , "bFilter": true //搜索栏
                , "bAutoWidth": true  //自适应宽度
                , "sPaginationType": "full_numbers" //分页，一共两种样式，full_numbers和two_button(默认)
                , "bJQueryUI": false //开关，是否启用JQueryUI风格
                , "bSort": false
                , "processing": true
                , "serverSide": true
                , "iDisplayLength": 10 //默认显示的记录数
            });
        }

        function ABonClick(obj) {
            $('#ABTableModal').modal('show');
            $("#ABConfrim").attr("ABFLG",$(obj).attr("id"));
        }

        function queryABTable(obj) {
            var redaioVal = $(obj).val();
            $("#typeValue").val(redaioVal)
            ABTable.ajax.reload( null, true );
        }

        function chooseAB(obj) {
            var ABTable=document.getElementsByName("ABTable");
            var id = $(obj).attr("ABFLG");
            $.each(ABTable, function(i,v) {
                if(v.checked == true){
                    if(id == "firstParty"){
                        $("#firstParty").val($(this).attr("ABName")); // 甲方名
                        $("#firstParty").attr("value",$(this).val()); // 甲方 ID
                    }
                    if(id == "secondParty"){
                        $("#secondParty").val($(this).attr("ABName")); // 甲方名
                        $("#secondParty").attr("value",$(this).val()); // 甲方 ID
                    }
                }
            });
            $('#ABTableModal').modal('hide');
        }

        var contracttable;
        function contracttableLoad() {
            contracttable = $('#contracttable').DataTable({
                "sScrollX": true,
                "ajax": {
                    "url": "findContract",
                    "dataType": 'json',
                    "type": "POST",
                    contentType: 'application/json; charset=utf-8',

                    "data": function (d) {
                        var p = {};
                        p.draw = d.draw;
                        p.length = d.length;
                        p.start = d.start;
//                        p.name = $('#name').val();
                        p.code = $('#code').val();
                        p.exhibitionNumber = $('#exhibitionNumber').val();
                        p.category = $('#category').val();
                        p.firstParty = $('#firstParty').attr("value");
                        p.secondParty = $('#secondParty').attr("value");
                        var a = JSON.stringify(p);
                        return a;
                    }
                },

                "columns": [
                    {
                        "data": "id", "width": "270px",
                        "render": function (data, type, row) {
                            // 以下是合同相关
                            var e = '';// 编辑（高级经理）
                            if(hasEdit) {
                                e = "contractEdit?id=" + row.id;
                                e = '<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  href="javascript:loadPage(\'' + e + '\')" >编辑</a>';
                            }
                            var v = '';// 查看合同
                            if(hasContractView) {
                                v = "contractView?id=" + row.id;
                                v = '&nbsp;&nbsp;<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  href="javascript:loadPage(\'' + v + '\')" >查看合同</a>';
                            }

                            var dl = '';// 合同下载
                            if(contractDonwLoad) {
                                dl =  row.id;
                                dl = '&nbsp;&nbsp;<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  onclick="javascript:ledgerDonwLoad(\'' + dl + '\')" >合同下载</a>';
                            }

                            // 以下是台账相关
                            var el = '';// 编辑台账
                            if(hasLedgerEdit) {
                                var ledgerCount = row.ledgerCount;
                                el =  row.id;
                                if(ledgerCount == 0){
                                    el = '&nbsp;&nbsp;<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  onclick="javascript:showLedger(\'' + el + '\' ,\'ledgerEdit\',this)" >新建台账</a>';
                                }else {
                                    el = '&nbsp;&nbsp;<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  onclick="javascript:showLedger(\'' + el + '\' ,\'ledgerEdit\',this)" >编辑台账</a>';
                                }

                            }

                            var vl = '';// 查看台账
                            if(hasLedgerView) {
                                vl =  row.id;
                                vl = '&nbsp;&nbsp;<a type="button"  style="padding:0px 5px;line-height:1.4;margin-bottom: 0px;" class="btn btn-primary btn-xs"  onclick="javascript:showLedger(\'' + vl + '\' ,\'ledgerView\',this)" >查看台账</a>';
                            }


                            if(e == '' && v== '' && el== ''&& vl== ''&& dl== ''){
                                return '--'
                            }
                            return e  + v + el+ vl+ dl;

                        },
                    },
                    {"data": "signDay", "width": "100px"},
//                    {"data": "name", "width": "100px"},
                    {"data": "code", "width": "150px"},
                    {"data": "projectCode", "width": "100px"},
                    {"data": "projectName", "width": "150px"},
                    {"data": "campaignName", "width": "150px"},
                    {"data": "exhibitionNumber", "width": "100px"},
                    {"data": "amount", "width": "100px"},
                    {
                        "data": "category", "width": "180px",
                        "render": function (data, type, full, meta) {
                            if (data == 'C') {
                                return '销售合同';
                            }
                            else if (data == 'S') {
                                return '供应商合同-主办方';
                            }
                            else if (data == 'D') {
                                return '供应商合同-设计师';
                            }
                            else if (data == 'F') {
                                return '供应商合同-工厂';
                            }
                            else if (data == 'P') {
                                return '供应商合同-项目经理';
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        "data": "createTime", "width": "140px"
                    },
                    {
                        "data": "modifyTime", "width": "140px"
                    }
                ]
                , language: {
                    lengthMenu: '每页显示 <select class="form-control input-sm">'
                    + '<option value="20">20</option>'
                    + '<option value="40">40</option>'
                    + '<option value="100">100</option>'
                    + '</select> 个合同'
                    ,
                    processing: "载入中 ...",//处理页面数据的时候的显示
                    paginate: {//分页的样式文本内容。
                        previous: "上一页",
                        next: "下一页",
                        first: "第一页",
                        last: "最后一页"
                    },
                    "sSearch": "搜索",
                    zeroRecords: "没有合同",//table tbody内容为空时，tbody的内容。
                    //下面三者构成了总体的左下角的内容。
                    info: "当前显示第_START_到第_END_个合同 ，共_PAGES_ 页 ",//左下角的信息显示，大写的词为关键字。
                    infoEmpty: "0个合同",//筛选为空时左下角的显示。
                    infoFiltered: ""//筛选之后的左下角筛选提示(另一个是分页信息显示，在上面的info中已经设置，所以可以不显示)，
                }
                , "lengthChange": true
                , "bFilter": false //搜索栏
                , "bAutoWidth": true  //自适应宽度
                , "sPaginationType": "full_numbers" //分页，一共两种样式，full_numbers和two_button(默认)
                , "bJQueryUI": false //开关，是否启用JQueryUI风格
                , "bSort": false
                , "processing": true
                , "serverSide": true
                , "iDisplayLength": 20 //默认显示的记录数
            });
        }
        function resetForm(){
            $('#name').val("");
            $('#code').val("");
            $('#exhibitionNumber').val("");
            $("#category option[value='']").attr("selected", false)
            $("#category option[value='']").attr("selected", true)
            $('#firstParty').val("");
            $('#firstParty').attr("value","");
            $('#secondParty').val("");
            $('#secondParty').attr("value","");
            contracttable.ajax.reload( null, true ); // contract paging is not reset on reload
        }
        function query(){
            contracttable.ajax.reload( null, true ); // contract paging is not reset on reload
        }
        var a = 0;
        $(document).ready(function () {
            // 提示栏初始化
            contracttableLoad();
            var v =''
            if(hasCreate) v = "<button style='margin-left:20px;' class='btn btn-primary btn-sm btn-w-m' type='button' onclick='loadPage(\"contractEdit\");'>新&nbsp;&nbsp;建</button>"
            $("#contracttable_wrapper div").children().eq(0).append(v);

            $('#ABTableModal').on('shown.bs.modal',function(){
                if(ABTable == undefined && ABTable == null){
                    ABTableInit();// 甲乙合同表初始化
                }
            })
        });

        /***
         *
         * 台账相关
         *
         **/
        var format = "yyyy-mm-dd";
        var updateFlg;
        var ledgerListSize = $("#ledgerListSize").val();

        var moneyTypeStr = "<option value=\"\" selected=\"selected\">未选择</option>";
        var paymentMethodStr = "<option value=\"\" selected=\"selected\">未选择</option>";
        var costCenterStr = "<option value=\"\" selected=\"selected\">未选择</option>";
        var reasonForChangeStr  = "<option value=\"\" selected=\"selected\">未选择</option>";
        var moneyTypeList = /*[[${moneyTypeList}]]*/;
        if (moneyTypeList) {
            for (var a= 0;a < moneyTypeList.length;a++) {
                var moneyType = moneyTypeList[a];
                moneyTypeStr += '<option value="'+moneyType.id+'">'+moneyType.value+'</option>';
            }
        }

        var paymentMethodList = /*[[${paymentMethodList}]]*/;
        if (paymentMethodList) {
            for (var a= 0;a < paymentMethodList.length;a++) {
                var paymentMethod = paymentMethodList[a];
                paymentMethodStr += '<option value="'+paymentMethod.id+'">'+paymentMethod.value+'</option>';
            }
        }

        var costCenterList = /*[[${costCenterList}]]*/;
        if (costCenterList) {
            for (var a= 0;a < costCenterList.length;a++) {
                var costCenter = costCenterList[a];
                costCenterStr += '<option value="'+costCenter.id+'">'+costCenter.value+'</option>';
            }
        }

        var reasonForChangeList = /*[[${reasonForChangeList}]]*/;
        if (reasonForChangeList) {
            for (var a= 0;a < reasonForChangeList.length;a++) {
                var reasonForChange = reasonForChangeList[a];
                reasonForChangeStr += '<option value="'+reasonForChange.id+'">'+reasonForChange.value+'</option>';
            }
        }

        function ledgerCheck(ledgerListSize) {
            // create ledger check
            if(ledgerListSize == 0) {
                validateSelect('moneyType0', 'moneyType', 'validatMoneyType');
                validateSelect('paymentMethod0' + i, 'paymentMethod', 'validatPaymentMethod');
                validateSelect('costCenter0', 'costCenter', 'validatCostCenter');
                validateSelect('paymentTime0', 'paymentTime', 'validatPaymentTime');
                validate('paymentAmount0', 'paymentAmount', 'validatPaymentAmount');
                datepickerInit('paymentTime0', format);
                validate('operator0', 'operator', 'validatPerator');
                if (updateFlg == "true") validateSelect('reasonForChange0', 'reasonForChange', 'validatReasonForChange');
            }else{
                for (var i = 0; i < ledgerListSize; i++) {
                    validateSelect('moneyType' + i, 'moneyType', 'validatMoneyType');
                    validateSelect('paymentMethod' + i, 'paymentMethod', 'validatPaymentMethod');
                    validateSelect('costCenter' + i, 'costCenter', 'validatCostCenter');
                    validateSelect('paymentTime' + i, 'paymentTime', 'validatPaymentTime');
                    validate('paymentAmount' + i, 'paymentAmount', 'validatPaymentAmount');
                    datepickerInit('paymentTime' + i, format);
                    validate('operator' + i, 'operator', 'validatPerator');
                    if (updateFlg == "true") validateSelect('reasonForChange' + i, 'reasonForChange', 'validatReasonForChange');
                }
            }
        }

        function datepickerInit(id,format) {
            $('#'+id).datepicker({
                startView: 1,
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                autoclose: true,
                format: format,
                language: 'cn',
            });
        }
        // 添加台账
        function add() {
            var number = $("#ledgerList tr").length;
            var row ="<tr>\n" +
                "      <td>\n" +
                "          <div id=\"moneyType"+number+"Form\">\n" +
                "              <div >\n" +
                "                  <select class=\"form-control input-sm\" style=\"padding-top: 4px;width:95px;\" name=\"moneyType\" id=\"moneyType"+number+"\">\n" +
                "                      "+ moneyTypeStr +
                "                  </select>\n" +
                "              </div>\n" +
                "              <label class=\" control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"paymentMethod"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <select class=\"form-control input-sm\" style=\"padding-top: 4px;width:95px;\" name=\"paymentMethod\" id=\"paymentMethod"+number+"\">\n" +
                "                      "+ paymentMethodStr +
                "                  </select>\n" +
                "              </div>\n" +
                "              <label class=\" control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"costCenter"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <select class=\"form-control input-sm\" style=\"padding-top: 4px;width:95px;\" name=\"costCenter\" id=\"costCenter"+number+"\">\n" +
                "                      "+ costCenterStr +
                "                  </select>\n" +
                "              </div>\n" +
                "              <label class=\" control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"paymentTime"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <input type=\"text\" name=\"paymentTime\" id=\"paymentTime"+number+"\" class=\"form-control input-sm\" maxlength=\"50\" readonly=\"readonly\"/>\n" +
                "              </div>\n" +
                "              <label class=\"control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"paymentAmount"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <input type=\"text\"  name=\"paymentAmount\" id=\"paymentAmount"+number+"\" class=\"form-control input-sm\" oninput=\"if(value.length>18)value=value.slice(0,18)\"/>\n" +
                "              </div>\n" +
                "              <label class=\"control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"operator"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <input type=\"text\" name=\"operator\" id=\"operator"+number+"\" class=\"form-control input-sm\" maxlength=\"30\"/>\n" +
                "              </div>\n" +
                "              <label class=\"control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td>\n" +
                "          <div id=\"reasonForChange"+number+"Form\">\n" +
                "              <div>\n" +
                "                  <select class=\"form-control input-sm\" style=\"padding-top: 4px;width:95px;\" name=\"reasonForChange\" id=\"reasonForChange"+number+"\">\n" +
                "                      "+ reasonForChangeStr +
                "                  </select>\n" +
                "              </div>\n" +
                "              <label class=\" control-label\" style=\"text-align: left\"></label>\n" +
                "          </div>\n" +
                "      </td>\n" +
                "      <td >\n" +
                "          <button class=\"btn btn-primary btn-sm\" onclick=\"delBtnData(this)\" type=\"button\" style=\"width: 100%;\" >删&nbsp;&nbsp;除</button>\n" +
                "      </td>\n" +
                "  </tr>";
            $("#ledgerList").append(row);

            validateSelect('moneyType'+number, 'moneyType', 'validatMoneyType');
            validateSelect('paymentMethod'+number, 'paymentMethod', 'validatPaymentMethod');
            validateSelect('costCenter'+number, 'costCenter', 'validatCostCenter');
            validateSelect('paymentTime'+number, 'paymentTime', 'validatPaymentTime');
            validate('paymentAmount'+number, 'paymentAmount', 'validatPaymentAmount');
            datepickerInit('paymentTime'+number,format);
            validate('operator'+number, 'operator', 'validatPerator');

            if(updateFlg == "true") validateSelect('reasonForChange'+number, 'reasonForChange', 'validatReasonForChange');
            number++;

        }

        // 删除添加行
        function delBtnData(obj){
            $(obj).parent().parent().remove();
            updateId();
        }

        // 更新添加台账Form和input的Id
        function updateId() {
            $("#ledgerList tr").each(function(index){
                $(this).find($("div[id^='moneyType']")).attr("id","moneyType"+index+"Form");
                $(this).find($("select[id^='moneyType']")).attr("id","moneyType"+index);

                $(this).find($("div[id^='paymentMethod']")).attr("id","paymentMethod"+index+"Form");
                $(this).find($("select[id^='paymentMethod']")).attr("id","paymentMethod"+index);

                $(this).find($("div[id^='costCenter']")).attr("id","costCenter"+index+"Form");
                $(this).find($("select[id^='costCenter']")).attr("id","costCenter"+index);

                $(this).find($("div[id^='paymentTime']")).attr("id","paymentTime"+index+"Form");
                $(this).find($("input[id^='paymentTime']")).attr("id","paymentTime"+index);
                $(this).find($("div[id^='paymentAmount']")).attr("id","paymentAmount"+index+"Form");
                $(this).find($("input[id^='paymentAmount']")).attr("id","paymentAmount"+index);
                $(this).find($("div[id^='operator']")).attr("id","operator"+index+"Form");
                $(this).find($("input[id^='operator']")).attr("id","operator"+index);

                $(this).find($("div[id^='reasonForChange']")).attr("id","reasonForChange"+index+"Form");
                $(this).find($("select[id^='reasonForChange']")).attr("id","reasonForChange"+index);

            })
        }

        function ledgerDonwLoad(id) {
            // todo
        }

        var showLedgerbtn;
        function showLedger(id,url,btn) {
            showLedgerbtn = Ladda.create(btn);
            $.ajax({
                url: url,
                async: true,
                type: 'POST',
                data: {
                    id: id
                },
//                contentType: 'application/json; charset=utf-8',
                dataType: 'html',
                timeout: 300000,
                beforeSend: function () {
                    showLedgerbtn.start();
                },
                error: function (result) {
                    swal("操作失败", "通信错误!", "error");
                    showLedgerbtn.stop();
                },
                success: function (data) {
                    $('#ABTableModal').after(data)
                    $('#ledgerModal').on('hidden.bs.modal', function (e) {
                        var n = $('#ledgerModal');
                        n.remove();
                        $("#id").val("");
                    })
                    $('#ledgerModal').modal('show');
                    $("#id").val(id);
                    updateFlg = $("#updateFlg").val();
                    // 编辑时添加每行验证
                    ledgerCheck($("#ledgerListSize").val());
                    showLedgerbtn.stop();
                }
            });
        }

        // 台账隐藏
        function removeLedgerInfo(){
            $('#ledgerModal').modal('hide');
        }
        var saveBtnda;
        // 保存台账
        function saveLedger(btn) {
            saveBtnda = Ladda.create( btn );
            var ledgerList = [];
            $("#ledgerList tr").each(function(index){
                moneyType = $(this).find("select[name=moneyType]").val();
                paymentMethod = $(this).find("select[name=paymentMethod]").val();
                costCenter = $(this).find("select[name=costCenter]").val();
                paymentTime = $(this).find("input[name=paymentTime]").val();
                paymentAmount = $(this).find("input[name=paymentAmount]").val();
                operator = $(this).find("input[name=operator]").val();
                reasonForChange = $(this).find("select[name=reasonForChange]").val();
                ledgerList.push({
                    "moneyType":moneyType,
                    "paymentMethod":paymentMethod,
                    "costCenter":costCenter,
                    "paymentTime":paymentTime,
                    "paymentAmount":paymentAmount,
                    "operator":operator,
                    "reasonForChange":reasonForChange
                })
            })
            var p = {
                id: $("#id").val().trim(),
                ledgerList: ledgerList
            };

            var url = "saveLedger";
            if(updateFlg == "true"){
                var led = ledgerList;
                if(led.length > 0){
                    var rFlag = false;
                    for (var i = 0;i<led.length;i++){
                        var reasonForChange = led[i].reasonForChange;
                        if (reasonForChange == "" || reasonForChange == undefined || reasonForChange == null){
                            rFlag = true;
                            break;
                        }
                    }
                    if(rFlag){
                        url = "checkLedgerInfo2";
                    }
                }
            }

            var a = JSON.stringify(p);
            $.ajax({
                url: url, // 如果是更新的话‘变更原因’必须
                async: true,
                type: 'POST',
                data: a,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                timeout: 300000,
                beforeSend: function () {
                    saveBtnda.start();
                },
                error: function (result) {
                    swal("操作失败", "通信错误!", "error");
                    saveBtnda.stop();
                },
                success: function (data) {
                    if (data.res == undefined) {
                        saveBtnda.stop();
                        for (var p in data) {
                            for (var p in data) {
                                var tempField = data[p].field;
                                if(tempField.startsWith("ledgerList[")){
                                    data[p].field= tempField.split(".")[1]+tempField.substring(tempField.indexOf("[")+1,tempField.indexOf("]"));
                                }
                                var tmp = $("#" + data[p].field).parent().next();

                                if (tmp.text() == '') {
                                    $("#" + data[p].field + "Form").addClass("has-error")
                                    var tmp = $("#" + data[p].field).parent().next();
                                    tmp.html(data[p].defaultMessage);
                                }
                            }
                        }
                        ledgerList = [];
                    }else{
                        saveBtnda.stop();
                        $('#ledgerModal').modal('hide');
                    }
                }
            });
            return ledgerList;
        }


        /*]]>*/
    </script>
</div>
</html>
