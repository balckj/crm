<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<div  th:fragment="contractEdit">
    <!--<link th:href="@{inspinia_admin/css/plugins/cropper/cropper.min.css}" rel="stylesheet"/>-->
    <!--<link th:href="@{inspinia_admin/css/plugins/select2/select2.min.css}" rel="stylesheet"/>-->
    <!--<link th:href="@{inspinia_admin/css/plugins/chosen/bootstrap-chosen.css}" rel="stylesheet"/>-->
    <link th:href="@{99/css/plugins/ladda/ladda-themeless.min.css}" rel="stylesheet"/>
    <link th:href="@{99/css/plugins/jqGrid/ui.jqgrid.css}" rel="stylesheet"/>
    <!--<link th:href="@{99/css/plugins/jqGrid/ui.jqgrid-bootstrap.css}" rel="stylesheet"/>-->
    <link th:href="@{99/css/plugins/jqGrid/ui.jqgrid-bootstrap-ui.css}" rel="stylesheet"/>
    <script th:src="@{jquery.koala.js}" type="text/javascript"></script>
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h2 th:text="${title}"></h2>
            <ol class="breadcrumb">
                <li>
                    <a href="index.html">首页</a>
                </li>
                <li>
                    <a>业务数据管理</a>
                </li>
                <li class="active">
                    <strong>报价单管理</strong>
                </li>
            </ol>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight ecommerce">

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <form method="POST" class="form-horizontal">
                            <!--<input type="hidden" name="id" id="id" th:value="${user}?${user.id}"/>-->
                            <div class="form-group" id="projectForm"><label class="col-sm-2 control-label">项目名称<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4">
                                    <select class="form-control m-b" name="project" id="project">
                                        <option value="" selected="selected">未选择</option>
                                        <option>option 1</option>
                                        <option>option 2</option>
                                        <option>option 3</option>
                                        <option>option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="priceLevelForm"><label class="col-sm-2 control-label">价格档次<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4">
                                    <select class="form-control m-b" name="priceLevel" id="priceLevel">
                                        <option value="" selected="selected">未选择</option>
                                        <option>option 1</option>
                                        <option>option 2</option>
                                        <option>option 3</option>
                                        <option>option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="workContentForm"><label class="col-sm-2 control-label">工作内容<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4"><input id="workContent" name="workContent" type="text"
                                                             class="form-control" maxlength="200" /></div>
                                <label class="col-sm-4 control-label" style="text-align: left"></label>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="remarkForm"><label class="col-sm-2 control-label">备注<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4"><input id="remark" name="remark" type="text"
                                                             class="form-control" maxlength="200" /></div>
                                <label class="col-sm-4 control-label" style="text-align: left"></label>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="productForm">
                                <label class="col-sm-2 control-label">产品信息<span
                                        style="color:#ed5565;">*</span></label>
                                <div class="col-sm-8">
                                    <table id="table"></table>
                                    <input type="BUTTON" id="add" value="add" />
                                </div>
                            </div>
                            <!--<div class="hr-line-dashed"></div>-->
                            <!--<div class="form-group" id="nameForm"><label class="col-sm-2 control-label">产品名称<span-->
                                    <!--style="color:#ed5565;">*</span></label>-->
                                <!--<div class="col-sm-4"><input id="name" name="name" type="text"-->
                                                             <!--class="form-control" maxlength="200" /></div>-->
                                <!--<label class="col-sm-4 control-label" style="text-align: left"></label>-->
                            <!--</div>-->
                            <!--<div class="hr-line-dashed"></div>-->
                            <!--<div class="form-group" id="categoryForm"><label class="col-sm-2 control-label">产品分类<span-->
                                    <!--style="color:#ed5565;">*</span></label>-->
                                <!--<div class="col-sm-4"><input id="category" name="category" type="text"-->
                                                             <!--class="form-control" maxlength="200" /></div>-->
                                <!--<label class="col-sm-4 control-label" style="text-align: left"></label>-->
                            <!--</div>-->
                            <!--<div class="hr-line-dashed"></div>-->
                            <!--<div class="form-group" id="unitForm"><label class="col-sm-2 control-label">单位<span-->
                                    <!--style="color:#ed5565;">*</span></label>-->
                                <!--<div class="col-sm-4"><input id="unit" name="unit" type="text"-->
                                                             <!--class="form-control" maxlength="200" /></div>-->
                                <!--<label class="col-sm-4 control-label" style="text-align: left"></label>-->
                            <!--</div>-->
                            <!--<div class="hr-line-dashed"></div>-->
                            <!--<div class="form-group" id="unitPriceForm"><label class="col-sm-2 control-label">单价<span-->
                                    <!--style="color:#ed5565;">*</span></label>-->
                                <!--<div class="col-sm-4"><input id="unitPrice" name="unitPrice" type="text"-->
                                                             <!--class="form-control" maxlength="200" /></div>-->
                                <!--<label class="col-sm-4 control-label" style="text-align: left"></label>-->
                            <!--</div>-->
                            <!--<div class="hr-line-dashed"></div>-->
                            <!--<div class="form-group" id="countForm"><label class="col-sm-2 control-label">数量<span-->
                                    <!--style="color:#ed5565;">*</span></label>-->
                                <!--<div class="col-sm-4"><input id="count" name="count" type="text"-->
                                                             <!--class="form-control" maxlength="200" /></div>-->
                                <!--<label class="col-sm-4 control-label" style="text-align: left"></label>-->
                            <!--</div>-->
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <button id="saveBtn" class="btn ladda-button btn-w-m btn-primary" data-style="zoom-in" type="button" onclick="saveUser(this);">
                                        <span class="ladda-label">保&nbsp;&nbsp;存</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="campaignTableModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 >请选择一个活动</h3>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-content">
                                <table id="campaignTable" class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>操作</th>
                                        <th>活动名称</th>
                                        <th>开始时间</th>
                                        <th>结束时间</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn ladda-button btn-primary" onclick="chooseActivity(this);"><span class="ladda-label">确定</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image cropper -->
    <!--<script th:src="@{inspinia_admin/js/plugins/cropper/cropper.min.js}"></script>-->
    <!-- Data picker -->
    <script th:src="@{99/js/plugins/datapicker/bootstrap-datepicker.js}"></script>
    <script th:src="@{99/js/plugins/ladda/spin.min.js}"></script>
    <script th:src="@{99/js/plugins/ladda/ladda.min.js}"></script>
    <script th:src="@{99/js/plugins/jqGrid/jquery.jqGrid.min.js}"></script>
    <!-- Select2 -->
    <!--<script th:src="@{inspinia_admin/js/plugins/select2/select2.full.min.js}"></script>-->

    <!-- Chosen -->
    <!--<script th:src="@{inspinia_admin/js/plugins/chosen/chosen.jquery.js}"></script>-->
    <script th:src="@{me.js}" type="text/javascript"></script>

    <script type="text/javascript">
        /*<![CDATA[*/

        $(document).ready(function() {
            $('#campaignTableModal').on('shown.bs.modal',function(){
                if(campaignTable == undefined && campaignTable == null){
                    campaignTableInit();// 项目table初始化
                }
            })
            pageInit();
        });
        var mydata = [
            {id : "1",name : "test",note : "note",amount : "200.00",tax : "10.00",total : "210.00"},
            {id : "2",name : "test2",note : "note2",amount : "300.00",tax : "20.00",total : "320.00"}
//            {id : "3",name : "test3",note : "note3",amount : "400.00",tax : "30.00",total : "430.00"},
//            {id : "4",name : "test",note : "note",amount : "200.00",tax : "10.00",total : "210.00"},
//            {id : "5",name : "test2",note : "note2",amount : "300.00",tax : "20.00",total : "320.00"},
//            {id : "6",name : "test3",note : "note3",amount : "400.00",tax : "30.00",total : "430.00"},
//            {id : "7",name : "test",note : "note",amount : "200.00",tax : "10.00",total : "210.00"},
//            {id : "8",name : "test2",note : "note2",amount : "300.00",tax : "20.00",total : "320.00"},
//            {id : "9",name : "test3",note : "note3",amount : "400.00",tax : "30.00",total : "430.00"},

        ];

        function getNames(){
            //动态生成产品名称
            var str= "";
            $.ajax({
                type:"post",
                async:false,
                url:"getProductName",
                success:function(data){
                    if (data != null) {
                        var jsonobj=eval(data);
                        var length=jsonobj.length;
                        for(var i=0;i<length;i++){
                            if(i!=length-1){
                                str+=jsonobj[i].personType+":"+jsonobj[i].personType+";";
                            }else{
                                str+=jsonobj[i].personType+":"+jsonobj[i].personType;// 这里是option里面的 value:label
                            }
                        }
                    }
                    alert(str);
                }
            });
            return str;
        }

        function campaignClick() {
            $('#campaignTableModal').modal('show');
        }

        var campaignTable = null;
        function campaignTableInit() {
            campaignTable = $('#campaignTable').DataTable({
                "sScrollX": true,
                "ajax": {
                    "url": "findActivity",
                    "dataType": 'json',
                    "type": "POST",
                    contentType: 'application/json; charset=utf-8',

                    "data": function (d) {
                        var p = {};
                        p.draw = d.draw;
                        p.length = d.length;
                        p.start = d.start;
                        p.search = d.search.value;
                        var a = JSON.stringify(p);
                        return a;
                    }
                },

                "columns": [
                    {
                        "data": "id", "width": "80px",
                        "render": function (data, type, row) {
                            var u = "";
                            u =  "<input type=\"radio\" name='activity' value='" + row.id + "' activityName='" + row.name + "' sponser='"+row.customerName+"' sponserid='"+row.sponsor+"' ' />";
                            return u;

                        },
                    },

                    {"data": "name", "width": "200px"},
                    {"data": "startDate", "width": "100px"},
                    {"data": "endDate", "width": "100px"},
                ]
                , language: {
                    lengthMenu: '每页显示 <select class="form-control input-sm">'
                    + '<option value="20">20</option>'
                    + '<option value="40">40</option>'
                    + '<option value="100">100</option>'
                    + '</select> 个项目'
                    ,
                    processing: "载入中 ...",//处理页面数据的时候的显示
                    paginate: {//分页的样式文本内容。
                        previous: "上一页",
                        next: "下一页",
                        first: "第一页",
                        last: "最后一页"
                    },
                    "sSearch": "搜索",
                    zeroRecords: "没有用户",//table tbody内容为空时，tbody的内容。
                    //下面三者构成了总体的左下角的内容。
                    info: "当前显示第_START_到第_END_个用户 ，共_PAGES_ 页 ",//左下角的信息显示，大写的词为关键字。
                    infoEmpty: "0个用户",//筛选为空时左下角的显示。
                    infoFiltered: ""//筛选之后的左下角筛选提示(另一个是分页信息显示，在上面的info中已经设置，所以可以不显示)，
                }
                , "lengthChange": true
                , "bFilter": true //搜索栏
                , "bAutoWidth": true  //自适应宽度
                , "sPaginationType": "full_numbers" //分页，一共两种样式，full_numbers和two_button(默认)
                , "bJQueryUI": false //开关，是否启用JQueryUI风格
                , "bSort": false
                , "processing": true
                , "serverSide": true
                , "iDisplayLength": 20 //默认显示的记录数
            });
        }
        function chooseActivity() {
            var activity=document.getElementsByName("activity");
            $.each(activity, function(i,v) {
                if(v.checked == true){
                    $("#campaignId").val($(this).attr("activityName")); // 项目编号
                    $("#campaignId").attr("campaignid",$(this).val());
                    if($('#type option:selected').text()=="办展"){
                        $("#customerId").val($(this).attr("sponser"));
                        $("#customerId").attr("customerid",$(this).attr("sponserid"));
                    }
                }
            });

            $('#campaignTableModal').modal('hide');
            $("#campaignId").change();
        }


        function pageInit(){
            var lastsel;
            $("#table").jqGrid({
                    data:mydata,
                    datatype : "local",
                    height : 250,
                    colNames : ['操作','ID','产品名称', '产品分类', '单位', '单价', '数量' ],
                    colModel : [
//                        {name : 'id',index : 'id',width : 60,sorttype : "int"},
//                        {name : 'name',index : 'name',width : 100},
//                        {name : 'amount',index : 'amount',width : 80,align : "right",sorttype : "float"},
//                        {name : 'tax',index : 'tax',width : 80,align : "right",sorttype : "float"},
//                        {name : 'total',index : 'total',width : 80,align : "right",sorttype : "float"}
                        {name:'act',index:'act',width:110,search:false,sortable:false,editable:false},
                        {name : 'id',index : 'id',width : 60,sorttype : "int",hidden:true},
                        {name : 'name',index : 'name',width : 100,editable : true,formatter: cLink,
//                            editoptions:{value: "FE:FedEx; IN:InTime; TN:TNT"}
                        },
                        {name : 'note',index : 'note',width : 100,  edittype:'text',
                            editoptions:{size:10,maxlength:15},
                            editrules:{required:true}
//                            formoptions:{elmprefix:'(*)'}
                        },
                        {name : 'amount',index : 'amount',width : 80,align : "right",editable : false},
                        {name : 'tax',index : 'tax',width : 80,align : "right",editable : false},
                        {name : 'total',index : 'total',width : 80,align : "right",editable : true}
                    ],
                    multiselect : false,
                    onSelectRow : function(id) {
                        if (id && id !== lastsel) {
                            $('#table').jqGrid('restoreRow', lastsel);
                            $('#table').jqGrid('editRow', id, true);
                            lastsel = id;
                        }
                    },
                    gridComplete: function(){
                        debugger;
                        var ids = $("#table").getDataIDs();//jqGrid('getDataIDs');
                        for(var i=0;i<ids.length;i++){
                            var cl = ids[i];
                            be = "<input style='height:22px;width:40px;' type='button' value='编辑' onclick=\"$('#table').jqGrid('editGridRow','"+cl+"',{checkOnSubmit:true,checkOnUpdate:true,closeAfterEdit:true,closeOnEscape:true});\"  />";
                            de = "<input style='height:22px;width:40px;' type='button' value='删除' onclick=\"$('#table').jqGrid('delGridRow','"+cl+"');\"  />";
                            $("#table").jqGrid('setRowData',ids[i],{act:be+de});
                        }
                    },
                    caption : "产品信息"
            });

            function cLink(cellvalue, options, rowObject){
                return '<a href="javascript:void(0)" onclick="campaignClick()">请选择产品名称</a>';
            }

            $("#add").click(function() {
//                $("#table").jqGrid('editGridRow', "new", {
//                    height : 300,
//                    reloadAfterSubmit : false,
//                    addCaption: "Add Record",
//                    editCaption: "Edit Record",
//                    Submit: "Submit",
//                    Cancel: "Cancel",
//                    Close: "Close",
//                    saveData: "Data has been changed! Save changes?",
//                    Yes : "Yes",
//                    No : "No",
//                    Exit : "Cancel",
//                });
                addRow();
            });

            //grid添加新的一行
            var newrowid ;
            function addRow()
            {
                $("#operate").val("");
                var selectedId = $("#table").jqGrid("getGridParam", "selrow");
                var ids = $("#table").jqGrid('getDataIDs');
                //获得当前最大行号（数据编号）
                var rowid = Math.max.apply(Math,ids);
                //获得新添加行的行号（数据编号）
                newrowid = rowid+1;
                var dataRow = {
                    id: "",
                    name:"",
                    note:'',
                    amount:'',
                    tax:'',
                    total:''
                };

                //将新添加的行插入到第一列
                $("#table").jqGrid("addRowData", newrowid, dataRow, "last");
                //设置grid单元格不可编辑
                $("#table").setGridParam({cellEdit:false});
                //设置grid单元格可编辑
                $('#table').jqGrid('editRow', newrowid, false);
                //给添加的列加选择按钮
//                var $zoneInput = $("#"+newrowid+"_zoneName");
//                $zoneInput.attr("disabled",true).css("width",100);
//                $zoneInput.after("<input type='button' value='选择' onclick='fnCallDialogForEidt()' />");

            }


//            function pickdates(id) {
//                $("#" + id + "_sdate", "#rowed6").datepicker({
//                    dateFormat: "yy-mm-dd"
//                });
//            }
        }


        validate('name', 'name', 'validateUserName');
        validate2('mobilePhone', 'mobile', {isEdit: false}, 'validateMobile');
        validate('password', 'password', 'validatePassword');
        //        validate('totalLessons', 'integer', 'validateInteger');
        validate('email', 'email', 'validateEmail');



        var saveBtnda;
        function saveUser(btn) {
            saveBtnda = Ladda.create( btn );
            var product ={
                category: $("#category").val().trim(),
                name: $("#name").val().trim(),
                unit: $("#unit").val()
            };
            var p = {
                id: $("#id").val().trim(),
                priceLevel: $("#priceLevel").val(),
                product:product,
                unitPrice: $("#unitPrice").val(),
                count: $("#count").val(),
                workContent: $("#workContent").val(),
                remark: $("#remark").val(),
            };
            var a = JSON.stringify(p);
            debugger;
            $.ajax({
                url: 'saveQuotation',
                async: true,
                type: 'POST',
                data: a,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                timeout: 300000,
                beforeSend: function () {
                    saveBtnda.start();
                },
                error: function (result) {
                    alert("通信错误！");
                },
                success: function (data) {
                    if (data.res == undefined) {
                        saveBtnda.stop();
                        for (var p in data) {
                            var tmp = $("#" + data[p].field).parent().next();

                            if (tmp.text() == '') {
                                $("#" + data[p].field + "Form").addClass("has-error")
                                var tmp = $("#" + data[p].field).parent().next();
                                tmp.html(data[p].defaultMessage);
                            }
                        }
                    }else{

                        loadPage("userList",function(){
                            saveBtnda.stop();
                        });
                    }
                }
            });
        }
        /*]]>*/
    </script>
</div>
</html>
