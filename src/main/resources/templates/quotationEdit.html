<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<div  th:fragment="quotationEdit">
    <link th:href="@{99/css/plugins/ladda/ladda-themeless.min.css}" rel="stylesheet"/>
    <link th:href="@{99/css/plugins/jQueryUI/jquery-ui-1.10.4.custom.min.css}" rel="stylesheet"/>
    <link th:href="@{99/css/plugins/jqGrid/ui.jqgrid.css}" rel="stylesheet"/>
    <script th:src="@{jquery.koala.js}" type="text/javascript"></script>
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h2 th:text="${title}"></h2>
            <ol class="breadcrumb">
                <li>
                    <a href="index.html">首页</a>
                </li>
                <li>
                    <a>业务数据管理</a>
                </li>
                <li class="active">
                    <strong>报价单管理</strong>
                </li>
            </ol>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight ecommerce">

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <form method="POST" class="form-horizontal">
                            <!--<input type="hidden" name="id" id="id" th:value="${user}?${user.id}"/>-->
                            <div class="form-group" id="projectIdForm"><label class="col-sm-2 control-label">项目名称<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4">
                                    <input id="projectId" name="projectId" placeholder="请选择项目名称" readonly="readonly" type="text" th:value="${quotation}?${quotation.projectId}"
                                           class="form-control" maxlength="200" onclick="projectClick();" style="cursor:pointer;"/>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="priceLevelForm"><label class="col-sm-2 control-label">价格档次<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4">
                                    <select class="form-control m-b" name="priceLevel" id="priceLevel">
                                        <option value="" selected="selected">未选择</option>
                                        <option value="1">低价</option>
                                        <option value="2">中价</option>
                                        <option value="3">高价</option>
                                    </select>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="workContentForm"><label class="col-sm-2 control-label">工作内容<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4"><input id="workContent" name="workContent" type="text"
                                                             class="form-control" maxlength="200" /></div>
                                <label class="col-sm-4 control-label" style="text-align: left"></label>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="remarkForm"><label class="col-sm-2 control-label">备注<span
                                    style="color:#ed5565;">*</span></label>
                                <div class="col-sm-4"><input id="remark" name="remark" type="text"
                                                             class="form-control" maxlength="200" /></div>
                                <label class="col-sm-4 control-label" style="text-align: left"></label>
                            </div>


                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="productForm">
                                <label class="col-sm-2 control-label">产品信息<span
                                        style="color:#ed5565;">*</span></label>
                                <div class="col-sm-8">
                                    <table id="table"></table>
                                    <input type="BUTTON" id="add" value="add" />
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <button id="saveBtn" class="btn ladda-button btn-w-m btn-primary" data-style="zoom-in" type="button" onclick="saveUser(this);">
                                        <span class="ladda-label">保&nbsp;&nbsp;存</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="quotationTableModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 >请选择一个产品</h3>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-content">
                                <table id="quotationTable" class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>操作</th>
                                        <th>产品名称</th>
                                        <th>产品分类</th>
                                        <th>单位</th>
                                        <th>单价</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn ladda-button btn-primary" onclick="chooseProduct(this);"><span class="ladda-label">确定</span></button>
                </div>
            </div>
        </div>
    </div>

    <!--项目Modal-->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="projectTableModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 >请选择一个项目</h3>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-content">
                                <table id="projectTable" class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>操作</th>
                                        <th>项目名称</th>
                                        <th>项目编号</th>
                                        <th>市场活动</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn ladda-button btn-primary" onclick="chooseProject(this);"><span class="ladda-label">确定</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data picker -->
    <script th:src="@{99/js/plugins/datapicker/bootstrap-datepicker.js}"></script>
    <script th:src="@{99/js/plugins/ladda/spin.min.js}"></script>
    <script th:src="@{99/js/plugins/ladda/ladda.min.js}"></script>
    <script th:src="@{99/js/plugins/jqGrid/i18n/grid.locale-en.js}"></script>
    <script th:src="@{99/js/plugins/jqGrid/jquery.jqGrid.min.js}"></script>

    <script th:src="@{me.js}" type="text/javascript"></script>

    <!--jrw-->
    <script type="text/javascript">
        /*<![CDATA[*/
        var projectTable = null;
        $(function () {
            $('#projectTableModal').on('shown.bs.modal',function(){
                if(projectTable == undefined && projectTable == null){
                    projectTableInit();// 项目table初始化
                }
            })
        })
        // show项目table
        function projectClick() {
            $('#projectTableModal').modal('show');
        }
        /***
         *
         * 项目相关
         *
         **/
        function projectTableInit() {
            projectTable = $('#projectTable').DataTable({
                "sScrollX": true,
                "ajax": {
                    "url": "findProject",
                    "dataType": 'json',
                    "type": "POST",
                    contentType: 'application/json; charset=utf-8',

                    "data": function (d) {
                        var p = {};
                        p.draw = d.draw;
                        p.length = d.length;
                        p.start = d.start;
                        p.search = d.search.value;
                        var a = JSON.stringify(p);
                        return a;
                    }
                },

                "columns": [
                    {
                        "data": "id", "width": "50px",
                        "render": function (data, type, row) {
                            var u = "";
                            u =  "<input type=\"radio\" style=\"cursor:pointer;\" name='project' value='" + row.id + "' proName='" + row.name + "'/>";
                            return u;

                        },
                    },

                    {"data": "name", "width": "200px"},
                    {"data": "code", "width": "100px"},
                    {"data": "campaignName", "width": "100px"},
                ]
                , language: {
                    lengthMenu: '每页显示 <select class="form-control input-sm">'
                    + '<option value="20">20</option>'
                    + '<option value="40">40</option>'
                    + '<option value="100">100</option>'
                    + '</select> 个项目'
                    ,
                    processing: "载入中 ...",//处理页面数据的时候的显示
                    paginate: {//分页的样式文本内容。
                        previous: "上一页",
                        next: "下一页",
                        first: "第一页",
                        last: "最后一页"
                    },
                    "sSearch": "搜索",
                    zeroRecords: "没有用户",//table tbody内容为空时，tbody的内容。
                    //下面三者构成了总体的左下角的内容。
                    info: "当前显示第_START_到第_END_个用户 ，共_PAGES_ 页 ",//左下角的信息显示，大写的词为关键字。
                    infoEmpty: "0个用户",//筛选为空时左下角的显示。
                    infoFiltered: ""//筛选之后的左下角筛选提示(另一个是分页信息显示，在上面的info中已经设置，所以可以不显示)，
                }
                , "lengthChange": true
                , "bFilter": true //搜索栏
                , "bAutoWidth": true  //自适应宽度
                , "sPaginationType": "full_numbers" //分页，一共两种样式，full_numbers和two_button(默认)
                , "bJQueryUI": false //开关，是否启用JQueryUI风格
                , "bSort": false
                , "processing": true
                , "serverSide": true
                , "iDisplayLength": 20 //默认显示的记录数
            });
        }

        // 选择一个项目
        function chooseProject() {
            var project=document.getElementsByName("project");
            $.each(project, function(i,v) {
                if(v.checked == true){
                    $("#projectId").attr("valueSetID",$(this).val()); // 项目 ID
                    $("#projectId").val($(this).attr("proName")); // 项目名称
                }
            });
            $("#projectId").change();
            $('#projectTableModal').modal('hide');
        }


        /*]]>*/
    </script>

    <script type="text/javascript">
        /*<![CDATA[*/
        var lastsel;

        $(document).ready(function() {
            $('#quotationTableModal').on('shown.bs.modal',function(){
                if(quotationTable == undefined && quotationTable == null){
                    quotationTableInit();// 项目table初始化
                }
            })
            pageInit();
            $("#table").on("click", ".mark_data", function(){
                campaignClick();
            });
        });
        var mydata = [
            {id : "1",name : "test",category : "category",unit : "200.00",price : "10.00",num : "210.00"},
            {id : "2",name : "test2",category : "category2",unit : "300.00",price : "20.00",num : "320.00"}
//            {id : "3",name : "test3",category : "category3",unit : "400.00",price : "30.00",num : "430.00"},
//            {id : "4",name : "test",category : "category",unit : "200.00",price : "10.00",num : "210.00"},
//            {id : "5",name : "test2",category : "category2",unit : "300.00",price : "20.00",num : "320.00"},
//            {id : "6",name : "test3",category : "category3",unit : "400.00",price : "30.00",num : "430.00"},
//            {id : "7",name : "test",category : "category",unit : "200.00",price : "10.00",num : "210.00"},
//            {id : "8",name : "test2",category : "category2",unit : "300.00",price : "20.00",num : "320.00"},
//            {id : "9",name : "test3",category : "category3",unit : "400.00",price : "30.00",num : "430.00"},

        ];


        function campaignClick() {
            $('#quotationTableModal').modal('show');
        }


        var fsdds=[
            {
                "data": "id", "width": "80px",
                "render": function (data, type, row) {
                    var u = "";
                    u =  "<input type=\"radio\" name='product' value='" + row.id + "' productName='" + row.name + "' category='"+row.category+"' unit='"+row.unit+"' low='"+row.low+"' middle='"+row.middle+"' high='"+row.high+"'' />";
                    return u;

                },
            },

            {"data": "name", "width": "130px"},
            {"data": "category", "width": "100px"},
            {"data": "unit", "width": "100px"}
        ]
        if($("#priceLevel").val()==1){
            var temp = {
                "data":"low",
                "width": "50px"
            };

            fsdds.push(temp);
        }else if($("#priceLevel").val()==2){
            var temp = {
                "data":"middle",
                "width": "50px"
            };
            fsdds.push(temp);
        }else {
            var temp = {
                "data":"high",
                "width": "50px"
            };
            fsdds.push(temp);
        }

        var quotationTable = null;
        function quotationTableInit() {
            quotationTable = $('#quotationTable').DataTable({
                "sScrollX": true,
                "ajax": {
                    "url": "findProduct",
                    "dataType": 'json',
                    "type": "POST",
                    contentType: 'application/json; charset=utf-8',

                    "data": function (d) {
                        var p = {};
                        p.draw = d.draw;
                        p.length = d.length;
                        p.start = d.start;
                        p.search = d.search.value;
                        var a = JSON.stringify(p);
                        return a;
                    }
                },

                "columns":fsdds,
                language: {
                    lengthMenu: '每页显示 <select class="form-control input-sm">'
                    + '<option value="20">20</option>'
                    + '<option value="40">40</option>'
                    + '<option value="100">100</option>'
                    + '</select> 个项目'
                    ,
                    processing: "载入中 ...",//处理页面数据的时候的显示
                    paginate: {//分页的样式文本内容。
                        previous: "上一页",
                        next: "下一页",
                        first: "第一页",
                        last: "最后一页"
                    },
                    "sSearch": "搜索",
                    zeroRecords: "没有用户",//table tbody内容为空时，tbody的内容。
                    //下面三者构成了总体的左下角的内容。
                    info: "当前显示第_START_到第_END_个用户 ，共_PAGES_ 页 ",//左下角的信息显示，大写的词为关键字。
                    infoEmpty: "0个用户",//筛选为空时左下角的显示。
                    infoFiltered: ""//筛选之后的左下角筛选提示(另一个是分页信息显示，在上面的info中已经设置，所以可以不显示)，
                }
                , "lengthChange": true
                , "bFilter": true //搜索栏
                , "bAutoWidth": true  //自适应宽度
                , "sPaginationType": "full_numbers" //分页，一共两种样式，full_numbers和two_button(默认)
                , "bJQueryUI": false //开关，是否启用JQueryUI风格
                , "bSort": false
                , "processing": true
                , "serverSide": true
                , "iDisplayLength": 20 //默认显示的记录数
            });
        }
        function chooseProduct() {
            var product=document.getElementsByName("product");
            debugger;
            $.each(product, function(i,v) {
                if(v.checked == true){
                    var price;
                    if($("#priceLevel").val()==1){
                        price = $(this).attr("low");
                    }else if($("#priceLevel").val()==2){
                        price = $(this).attr("middle");
                    }else {
                        price = $(this).attr("high");
                    }
                    var temp={
                        id: "",
                        name:$(this).attr("productName"),
                        category:$(this).attr("category"),
                        unit:$(this).attr("unit"),
                        price:price
                    }

                    $("#table").jqGrid("setRowData", lastsel, temp);

                }
            });

            $('#quotationTableModal').modal('hide');
        }


        function pageInit(){
            $("#table").jqGrid({
                    data:mydata,
                    datatype : "local",
                    height : 250,
                    colNames : ['操作','ID','产品名称', '产品分类', '单位', '单价', '数量' ],
                    colModel : [
//                        {name : 'id',index : 'id',width : 60,sorttype : "int"},
//                        {name : 'name',index : 'name',width : 100},
//                        {name : 'unit',index : 'unit',width : 80,align : "right",sorttype : "float"},
//                        {name : 'price',index : 'price',width : 80,align : "right",sorttype : "float"},
//                        {name : 'num',index : 'num',width : 80,align : "right",sorttype : "float"}
                        {name:'act',index:'act',width:50,search:false,sortable:false,editable:false},
                        {name : 'id',index : 'id',width : 60,sorttype : "int",hidden:true},
                        {name : 'name',index : 'name',width : 100,editable : false,formatter:function(cellvalue, options, rowObject){
//                            return "<span id='"+rowObject.id+"' class='mark_data' style='display:block; width:100%; cursor:pointer;'>"+cellvalue+"</span>";
                            return '<a href="javascript:void(0)" onclick="campaignClick()">'+cellvalue+'</a>';
                        }},
                        {name : 'category',index : 'category',width : 100,  edittype:'text',
                            editoptions:{size:10,maxlength:15},
                            editrules:{required:true}
//                            formoptions:{elmprefix:'(*)'}
                        },
                        {name : 'unit',index : 'unit',width : 80,align : "right",editable : false},
                        {name : 'price',index : 'price',width : 80,align : "right",editable : false},
                        {name : 'num',index : 'num',width : 80,align : "right",editable : true}
                    ],
                    multiselect : false,
                    onSelectRow : function(id) {
                        if (id && id !== lastsel) {
                            $('#table').jqGrid('restoreRow', lastsel);
                            $('#table').jqGrid('editRow', id, true);
                            lastsel = id;
                        }
                    },
                    onCellSelect:function (rowid,iCol,cellcontent,e) {
                       if(iCol==2){
                           lastsel = rowid;
                           campaignClick();
                       }
                    },
                    gridComplete: function(){
                        var ids = $("#table").getDataIDs();//jqGrid('getDataIDs');
                        for(var i=0;i<ids.length;i++){
                            var cl = ids[i];
                            de = "<input style='height:22px;width:40px;' type='button' value='删除' onclick=\"$('#table').jqGrid('delRowData','"+cl+"');\"  />";
                            $("#table").jqGrid('setRowData',ids[i],{act:de});
                        }
                    },
                    caption : "产品信息"
            });


            $("#add").click(function() {
                addRow();
            });

            //grid添加新的一行
            var newrowid ;
            function addRow()
            {
                var selectedId = $("#table").jqGrid("getGridParam", "selrow");
                var ids = $("#table").jqGrid('getDataIDs');
                //获得当前最大行号（数据编号）
                var rowid = Math.max.apply(Math,ids);
                //获得新添加行的行号（数据编号）
                newrowid = rowid+1;
                var dataRow = {
                    id: "",
                    name:"",
                    category:'',
                    unit:'',
                    price:'',
                    num:''
                };

                //将新添加的行插入到第一列
                $("#table").jqGrid("addRowData", newrowid, dataRow, "last");
                //设置grid单元格不可编辑
                $("#table").setGridParam({cellEdit:false});
                //设置grid单元格可编辑
                $('#table').jqGrid('editRow', newrowid, false);
                //给添加的列加选择按钮
//                var $zoneInput = $("#"+newrowid+"_zoneName");
//                $zoneInput.attr("disabled",true).css("width",100);
//                $zoneInput.after("<input type='button' value='选择' onclick='fnCallDialogForEidt()' />");

            }


//            function pickdates(id) {
//                $("#" + id + "_sdate", "#rowed6").datepicker({
//                    dateFormat: "yy-mm-dd"
//                });
//            }
        }


        validate('name', 'name', 'validateUserName');
        validate2('mobilePhone', 'mobile', {isEdit: false}, 'validateMobile');
        validate('password', 'password', 'validatePassword');
        //        validate('totalLessons', 'integer', 'validateInteger');
        validate('email', 'email', 'validateEmail');



        var saveBtnda;
        function saveUser(btn) {
            saveBtnda = Ladda.create( btn );
            var product ={
                category: $("#category").val().trim(),
                name: $("#name").val().trim(),
                unit: $("#unit").val()
            };
            var p = {
                id: $("#id").val().trim(),
                priceLevel: $("#priceLevel").val(),
                product:product,
                unitPrice: $("#unitPrice").val(),
                count: $("#count").val(),
                workContent: $("#workContent").val(),
                remark: $("#remark").val(),
            };
            var a = JSON.stringify(p);
            $.ajax({
                url: 'saveQuotation',
                async: true,
                type: 'POST',
                data: a,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                timeout: 300000,
                beforeSend: function () {
                    saveBtnda.start();
                },
                error: function (result) {
                    alert("通信错误！");
                },
                success: function (data) {
                    if (data.res == undefined) {
                        saveBtnda.stop();
                        for (var p in data) {
                            var tmp = $("#" + data[p].field).parent().next();

                            if (tmp.text() == '') {
                                $("#" + data[p].field + "Form").addClass("has-error")
                                var tmp = $("#" + data[p].field).parent().next();
                                tmp.html(data[p].defaultMessage);
                            }
                        }
                    }else{

                        loadPage("userList",function(){
                            saveBtnda.stop();
                        });
                    }
                }
            });
        }
        /*]]>*/
    </script>
</div>
</html>
